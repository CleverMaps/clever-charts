<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/4.8.0/d3.min.js"></script>
    <script src="dist/can-charts.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"/>
</head>

<style>
    .zoom-control {
        margin-left:100px;
    }

    .graphs-ct {
        margin-top:15px;
        display: none;
    }
</style>

<body>
    <input type="checkbox" class="change-selection-control">Disable bucket</button>
    <input type="checkbox" class="zoom-control">Zoom</button>
    <input type="checkbox" class="invert-control">Invert</button>
    <br>
    <div class="graphs-ct"></div>
    <script>
        // docs: https://github.com/d3/d3-format
        // all locales: https://unpkg.com/d3-format@1.2.0/locale/
        // set cs-CZ locale by default
        d3.formatDefaultLocale({
            "decimal": ",",
            "thousands": " ",
            "grouping": [
                3
            ],
            "currency": [
                "",
                " Kč"
            ]
        });

        // histogram 1 (default selection) ================================================================
        var histogram = new CanCharts.Histogram({
            width:360,
            promptHandler:(value)=>{
                return new Promise((success)=>{
                    var result = prompt("Sample prompt handler", value);
                    if (result !== null) {
                        success(result);
                    }
                })
            },
            height:150
        });

        histogram.render(".graphs-ct");

        var sampleSelection = [
            {"from":-37.27350427350427,"to":-30.286128521684077,"disabled":false,"color":"#55a3ec","opacity":0.1},
            {"from":-30.286128521684077,"to":-23.2987527699,"disabled":false,"color":"#55a3ec","opacity":0.29},
            {"from":-23.2987527699,"to":-16.311377018043686,"disabled":false,"color":"#55a3ec","opacity":0.48},
            {"from":-16.311377018043686,"to":-9.32400126622349,"disabled":false,"color":"#55a3ec","opacity":0.67},
            {"from":-9.32400126622349,"to":-2.336625514403292,"disabled":false,"color":"#55a3ec","opacity":0.86}
        ];

        d3.json("data/histogram/selection-issue.json", (json) => {
            histogram.setData(json.content,sampleSelection);  
        });

        d3.select(".change-selection-control").on("click", function(){
            sampleSelection[0].disabled = this.checked;
            histogram.setSelection(sampleSelection);
        });                   

        histogram.on("selectionOver", (selectionIndex)=>{
            console.log("histogram 1: selectionOver:"+selectionIndex);
        });

        histogram.on("toggleSelection", (selectionIndex, enabled)=>{
            console.log("histogram 1: toggleSelection:"+selectionIndex+", enabled:"+enabled);
        });

        histogram.on("selectionChanged", (selection)=>{
            console.log("histogram 1: selectionChanged:"+JSON.stringify(selection, null, 4));
        });

        histogram.on("handleClick", (handleIndex, handleValue)=>{
            console.log("histogram 1: handleClick: index: "+handleIndex+", value: "+handleValue);
        });

        // histogram 2 (filter) ==================================================================================
        var histogram2 = new CanCharts.Histogram({
            width:360,
            height:150,
            selectionType:CanCharts.Histogram.SelectionTypes.FILTER
        });

        histogram2.render(".graphs-ct");

        d3.json("data/histogram/buckets_full.json", (json) => {
            histogram2.setData(json.content, [{
                from:9591,
                to:20310
            }]);

            d3.select(".graphs-ct").style("display","block");
        });

        histogram2.on("selectionOver", (selectionIndex)=>{
            console.log("histogram 2: selectionOver:"+selectionIndex);
        });

        histogram2.on("toggleSelection", (selectionIndex, enabled)=>{
            console.log("histogram 2: toggleSelection:"+selectionIndex+", enabled:"+enabled);
        });        

        histogram2.on("selectionChanged", (selection)=>{
            console.log("histogram 2: selectionChanged:"+JSON.stringify(selection, null, 4));
        });        

        histogram2.on("handleClick", (handleIndex, handleValue)=>{
            console.log("histogram 2: handleClick:"+handleIndex+", value: "+handleValue);
        });        

        // simulate zoom
        d3.select(".zoom-control").on("click", function(){
            if (this.checked){
                d3.json("data/histogram/sample-zoom-issue.json", (json) => {
                    histogram2.setData(json.content, [{
                        from:9591,
                        to:20310
                    }],
                    {
                        animate:true
                    });
                });
            } else {
                d3.json("data/histogram/buckets_full.json", (json) => {
                    histogram2.setData(json.content, [{
                        from:9591,
                        to:20310
                    }],{
                        animate:true
                    });
                });
            }
        }).on("mouseover", function(){
            histogram2.showSelectionLabels();
        }).on("mouseout", function(){
            histogram2.hideSelectionLabels();
        }); 

        // simulate invert
        d3.select(".invert-control").on("click", function(){
            if (this.checked){
                histogram2.setSelectionType(Histogram.SelectionTypes.INVERTED_FILTER);
                
            } else {
                histogram2.setSelectionType(Histogram.SelectionTypes.FILTER);
            }
        });        
    </script>
</body>